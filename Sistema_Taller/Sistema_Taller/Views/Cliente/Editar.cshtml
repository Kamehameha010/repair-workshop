@model Sistema_Taller.Models.ViewModels.BuscarViewModel.BuscarCliente
@{
    ViewBag.Title = "Editar";
}

<h2>Editar</h2>


<div class="row">

    @using (Html.BeginForm())
    {
        
        @Html.ValidationSummary()
        <div class="row">
            @Html.HiddenFor(m => m.IdCliente, new { id = "IdCliente" })
            @Html.LabelFor(m => m.Nombre)
            @Html.EditorFor(m => m.Nombre, "", new { @class = "form-cotrol", id = "Nombre" })
            @Html.ValidationMessageFor(m => m.Nombre, "", new { @class = "text-danger" })
        </div>
        <div class="row">
            @Html.LabelFor(m => m.Apellidos)
            @Html.EditorFor(m => m.Apellidos, "", new { @class = "form-cotrol", id = "Apellidos" })
            @Html.ValidationMessageFor(m => m.Apellidos, "", new { @class = "text-danger" })
        </div>
        <div class="row">
            @Html.LabelFor(m => m.Cedula)
            @Html.EditorFor(m => m.Cedula, "", new { @class = "form-cotrol", id = "Cedula" })
            @Html.ValidationMessageFor(m => m.Cedula, "", new { @class = "text-danger" })
        </div>
        <div class="row">
            @Html.LabelFor(m => m.Telefono)
            @Html.EditorFor(m => m.Telefono, "", new { @class = "form-cotrol", id = "Telefono" })
            @Html.ValidationMessageFor(m => m.Telefono, "", new { @class = "text-danger", id = "Telefono" })
        </div>
        <div class="row">
            @Html.LabelFor(m => m.Correo)
            @Html.EditorFor(m => m.Correo, "", new { @class = "form-cotrol", id = "Correo" })
            @Html.ValidationMessageFor(m => m.Correo, "", new { @class = "text-danger" })
        </div>
        <div class="form-group">
            <input value="Agregar Empresa" type="button" id="add" />
        </div>
        <div class="modal fade" id="negocioModal" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header" style="padding:40px 50px;">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4><span class="glyphicon glyphicon-floppy-save"></span> Empresa</h4>
                    </div>
                    <div class="modal-body" style="padding: 40px 50px">
                        <form id="form2" role="form">
                            <div class="form-group">

                                <input type="hidden" id="idEmpresa" name="idEmpresa" />
                                <input type="hidden" id="idClienteE" name="idClienteE" />
                            </div>
                            <div class="form-group">
                                <label for="Nombre">Nombre:</label>
                                <input type="text" id="NombreEmpresa" name="NombreEmpresa" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label for="CedJuridica">Ced. Juridica:</label>
                                <input type="text" id="CedJuridica" name="CedJuridica" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label for="Direccion">Dirección:</label>
                                <input type="text" id="Direccion" name="Direccion" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label for="Telefono">Teléfono</label>
                                <input type="text" id="TelefonoEmp" name="TelefonoEmp" class="form-control" />
                            </div>
                            <div class="modal-footer">
                                <input type="button" data-dismiss="modal" value="Agregar" id="save" />
                                <input type="button" data-dismiss="modal" value="Editar" id="edit" />
                            </div>
                        </form>

                    </div>
                </div>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered table-hover" id="tablaNegocio">
                <thead>
                    <tr>
                        <th>@Html.DisplayName("Nombre")</th>
                        <th>@Html.DisplayName("Ced Juridica")</th>
                        <th>@Html.DisplayName("Dirección")</th>
                        <th>@Html.DisplayName("Teléfono")</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <br />
        <div class="form-group">

            <input type="button" value="Guardar" class="btn btn-success" id="Guardar" onclick="actualizar()" />


        </div>

    }

</div>
<script>

</script>
@section Scripts {

    <script type="text/javascript">
        var fila = 0;
        var lstEmp = [];
        var cliente;
        function Empresa(idEmpresa,Nombre, CedJuridica, Direccion, Telefono,idCliente) {

            this.Nombre = Nombre;
            this.CedJuridica = CedJuridica;
            this.Direccion = Direccion;
            this.Telefono = Telefono;
        }

        function Cliente(Nombre, Apellidos, Cedula, Telefono, Correo, Empresa) {
            this.Nombre = Nombre;
            this.Apellidos = Apellidos;
            this.Cedula = Cedula;
            this.Telefono = Telefono;
            this.Correo = Correo;
            this.Empresa = Empresa;
        }
        var btn_save = document.getElementById("save");
        var btn_edit = document.getElementById("edit");
        btn_save.addEventListener("click", nuevoNegocio);
        $(document).ready(function () {
            
            $("#add").click(function () {
                console.log("se repite dentro del click add");
                if (btn_save.style.display === "none") {
                    btn_save.style.display = "inline";
                }
                
                btn_edit.disable = true;
                btn_edit.style.display = "none";
                $("#negocioModal").modal(
                    $("#idEmpresa").val(fila),
                    $("#idClienteE").val(fila)
                );
            });
            buscar();
            

            
          /* $("#save").click(function () {
                nuevoNegocio(event);
            });*/
        });
        function nuevoNegocio(e) {
            if (document.getElementById("NombreEmpresa").value === "") {
                e.preventDefault();
            }
            else if (document.getElementById("Apellidos").value === "") {
                e.preventDefault();
            }
            else if (document.getElementById("CedJuridica").value === "") {
                e.preventDefault();
            }
            else {

                let tbody = document.querySelector("#tablaNegocio tbody");

                let row = tbody.insertRow(0);

                let elements = [$("#idEmpresa").val(), $("#NombreEmpresa").val(), $("#CedJuridica").val(), $("#Direccion").val(), $("#TelefonoEmp").val(), $("#IdCliente").val()];

                lstEmp.push(new Empresa(elements[0],elements[1],elements[2],elements[3],elements[4],elements[5]))
                
                for (let i = 0; i < elements.length; i++) {
                    
                    row.insertCell(i).innerHTML = elements[i];
                }
                row.cells[0].hidden = true;
                row.cells[5].hidden = true;
                row.insertCell(6).innerHTML = "<td><button type='button' class='edit alert-success'><span class='fa fa-edit'></span></button>\
                                                     <button type='button' class='delete alert-danger'><span class='fa fa-trash'></span></button></td>";
                fila++;

                eventos();
            }
        }


        function buscar() {
            let id = parseInt(/\d+$/.exec(location.href));

            fetch("/Cliente/BuscarCliente/?id=" + id, {
                headers: { 'Content-Type': 'application/json' }
            }).then(response => response.json())
                .then(data => {
                    $("#IdCliente").val(data.IdCliente);
                    $("#Nombre").val(data.Nombre);
                    $("#Apellidos").val(data.Apellidos);
                    $("#Cedula").val(data.Cedula);
                    $("#Telefono").val(data.Telefono);
                    $("#Correo").val(data.Correo);

                   //let table = document.getElementById("tablaNegocio");
                    let tbody = document.querySelector("#tablaNegocio tbody");
                    for (let i of data.Negocio) {
                        let tr = document.createElement("tr")
                        for (let j in i) {
                            let td = document.createElement("td");
                            if (j == "IdEmpresa" || j == "IdCliente") {
                                td.hidden = true;
                                td.textContent = i[j];

                            } else {
                                td.textContent = i[j];

                            }
                            tr.appendChild(td);
                        }

                        tr.innerHTML += "<td><button type='button' class='edit alert-success'><span class='fa fa-edit'></span></button>\
                                                         <button type='button' class='delete alert-danger'><span class='fa fa-trash'></span></button></td>"
                        tbody.appendChild(tr);
                        //table.appendChild(tbody);
                    }
                    eventos(); 
                }).catch(error => alert(error));
        }

        function actualizar() {

            let url = "/Cliente/Editar";
            cliente = new Cliente($("#Nombre").val(), $("#Apellidos").val(), $("#Cedula").val(),
                $("#Telefono").val(), $("#Correo").val(), lstEmp);
            cliente.idCliente = $("#IdCliente").val();
            let datos = {

                Nombre: document.getElementById("Nombre").value,
                Apellidos: document.getElementById("Apellidos").value,
                Cedula: document.getElementById("Cedula").value,
                Telefono: document.getElementById("Telefono").value,
                Correo: document.getElementById("Correo").value,
                IdCliente: document.getElementById("IdCliente").value
            }

            fetch(url, {
                method: 'POST',
                body: JSON.stringify(cliente),
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }

            }).then(response => {
                if (response.ok)
                    return response.json();
                else
                    throw new Error("Ha ocurrido un error");
            }).then(data => {
                if (data != "1")
                    alert("Nose pudo modificar el dato")
                else {
                    alert("Registro Modificado")
                    document.location.href = "/Cliente/";
                }
            }).catch(error => {
                alert(error);
            })


        }
    </script>
    @Scripts.Render("~/Scripts/FieldScripts/Filas.js")
}
